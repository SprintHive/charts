apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  name: "{{ printf "%s-%s-%s" .Values.Name .Values.Client.Role .Release.Name | trunc 24 }}"
  labels:
    heritage: {{.Release.Service | quote }}
    release: {{.Release.Name | quote }}
    chart: "{{.Chart.Name}}-{{.Chart.Version}}"
    component: {{.Values.Component}}
    role: {{.Values.Client.Role}}
spec:
  replicas: {{.Values.Client.Replicas }}
  serviceName: {{.Values.Name}}-{{.Values.Master.Role}}
  template:
    metadata:
      labels:
        component: {{.Values.Component}}
        role: {{.Values.Client.Role}}
    spec:
      serviceAccountName: {{.Values.Component}}
      containers:
      - name: {{.Values.Name}}-{{.Values.Client.Role}}
        securityContext:
          privileged: false
          capabilities:
            add:
            - IPC_LOCK
            - SYS_RESOURCE
        image: {{.Values.Image}}
        imagePullPolicy: {{.Values.ImagePullPolicy}}
        env:
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: CLUSTER_NAME
          value: {{.Values.ClusterName}}
        - name: NODE_NAME_PREFIX
          value: {{.Values.Name}}-{{.Values.Client.Role}}
        - name: DISCOVERY_SERVICE
          value: {{.Values.DiscoveryService.Name}}
        - name: NODE_MASTER
          value: "false"
        - name: NODE_DATA
          value: "false"
        - name: NODE_INGEST
          value: "true"
        - name: HTTP_ENABLE
          value: "true"
        - name: ES_JAVA_OPTS
          value: {{.Values.Client.JavaOpts}}
        - name: ES_PLUGINS_INSTALL
          value: {{ template "plugins" }}
      {{- if eq .Values.SearchGuard.Enabled true}}
        - name: TRANSPORT_TLS_KEY_PASS
          valueFrom:
            secretKeyRef:
              name: es-{{.Values.Client.Role}}-https-tls
              key: key-password
        - name: HTTPS_TLS_KEY_PASS
          valueFrom:
            secretKeyRef:
              name: es-{{.Values.Client.Role}}-transport-tls
              key: key-password
      {{- end}}
        ports:
        - containerPort: 9200
          name: http
          protocol: TCP
        - containerPort: 9300
          name: transport
          protocol: TCP
        resources:
          requests:
            cpu: "{{.Values.Client.CpuRequests}}"
            memory: "{{.Values.Client.MemoryRequests}}"
          limits:
            cpu: "{{.Values.Client.CpuLimits}}"
            memory: "{{.Values.Client.MemoryLimits}}"
        livenessProbe:
          tcpSocket:
            port: 9300
          initialDelaySeconds: {{.Values.Client.LivenessTest.InitialDelaySecs}}
          timeoutSeconds: {{.Values.Client.LivenessTest.TimeoutSecs}}
        readinessProbe:
          tcpSocket:
            port: 9200
          timeoutSeconds: 5
        volumeMounts:
        - name: storage
          mountPath: /data
        - name: configdir
          mountPath: /elasticsearch/config
      tolerations:
        - key: "type"
          operator: "Equal"
          value: "esnode"
          effect: "NoExecute"
      volumes:
      {{- if ne .Values.Client.VolumeClaimTemplate.Enabled true}}
      - name: storage
        emptyDir:
          medium: ""
      {{- end}}
      - name: configdir
        configMap:
          name: es-config
  {{- if eq .Values.Client.VolumeClaimTemplate.Enabled true}}
  volumeClaimTemplates:
    - metadata:
        name: storage
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: {{.Values.Client.VolumeClaimTemplate.StorageClass}}
        resources:
          requests:
            storage: {{.Values.Client.VolumeClaimTemplate.RequestedStorage}}
  {{- end}}
